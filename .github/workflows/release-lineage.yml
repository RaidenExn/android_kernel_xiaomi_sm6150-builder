name: Weekly builds

on:
  workflow_dispatch:
    inputs:
      build-lineage-20:
        description: 'Build LineageOS 20'
        required: false
        type: boolean
        default: false
      build-lineage-21:
        description: 'Build LineageOS 21'
        required: false
        type: boolean
        default: false
      build-lineage-22-2:
        description: 'Build LineageOS 22.2'
        required: false
        type: boolean
        default: false
      build-lineage-23-0:
        description: 'Build LineageOS 23.0'
        required: false
        type: boolean
        default: true
      enable-nethunter-full:
        description: 'Enable full NetHunter patches (HID, USB serial, extra drivers)'
        required: false
        type: boolean
        default: false
      enable-kprofiles:
        description: 'Enable KProfiles support (CPU/GPU profile management)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '5 5 * * 0'

permissions:
  contents: write

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      timestamp: ${{ steps.ts.outputs.TIME }}
      date: ${{ steps.ts.outputs.DATE }}
    steps:
      - name: Generate timestamp
        id: ts
        run: |
          DATE=$(date +'%Y%m%d')
          TIME=$(date +'%s')
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "TIME=$TIME" >> $GITHUB_OUTPUT

      - name: Determine build matrix
        id: set-matrix
        run: |
          # For scheduled builds, build all versions
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "ğŸ“… Scheduled build - building all versions"
            BUILDS=("lineage-20" "lineage-21" "lineage-22.2" "lineage-23.0")
          else
            # Manual workflow_dispatch - use selected inputs
            BUILDS=()
            if [[ "${{ inputs.build-lineage-20 }}" == "true" ]]; then
              BUILDS+=("lineage-20")
            fi
            if [[ "${{ inputs.build-lineage-21 }}" == "true" ]]; then
              BUILDS+=("lineage-21")
            fi
            if [[ "${{ inputs.build-lineage-22-2 }}" == "true" ]]; then
              BUILDS+=("lineage-22.2")
            fi
            if [[ "${{ inputs.build-lineage-23-0 }}" == "true" ]]; then
              BUILDS+=("lineage-23.0")
            fi
            
            # If no builds selected, default to lineage-23.0
            if [ ${#BUILDS[@]} -eq 0 ]; then
              BUILDS=("lineage-23.0")
              echo "âš ï¸ No versions selected, defaulting to lineage-23.0"
            fi
          fi
          
          echo "Selected builds: ${BUILDS[@]}"
          
          # Convert to JSON array properly
          JSON_ARRAY="["
          for i in "${!BUILDS[@]}"; do
            if [ $i -gt 0 ]; then
              JSON_ARRAY+=","
            fi
            JSON_ARRAY+="\"${BUILDS[$i]}\""
          done
          JSON_ARRAY+="]"
          
          echo "matrix={\"build-type\":$JSON_ARRAY}" >> $GITHUB_OUTPUT

  build:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v6.0.1

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          # Remove Android SDK (saves ~8-10GB)
          sudo rm -rf /usr/local/lib/android
          
          # Remove .NET (saves ~2GB)
          sudo rm -rf /usr/share/dotnet
          
          # Remove Swift (saves ~1.5GB)
          sudo rm -rf /usr/share/swift
          
          # Remove Haskell (saves ~1GB)
          sudo rm -rf /opt/ghc
          
          # Remove CodeQL (saves ~5GB)
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # Remove large packages
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*'
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # Remove Docker images (saves ~4GB)
          docker rmi $(docker images -q) 2>/dev/null || true
          
          echo ""
          echo "Disk space after cleanup:"
          df -h
          echo ""
          echo "Available space in /home/runner/work:"
          du -sh /home/runner/work

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2.14
        with:
          key: ccache-kernel-${{ matrix.build-type }}-${{ github.sha }}
          restore-keys: |
            ccache-kernel-${{ matrix.build-type }}-
            ccache-kernel-
          max-size: 2G

      - name: Cache toolchains
        uses: actions/cache@v5.0.1
        with:
          path: |
            clang
            gcc64
            gcc32
          key: toolchains-${{ runner.os }}-clang-r584948-gcc-latest
          restore-keys: |
            toolchains-${{ runner.os }}-clang-r584948-
            toolchains-${{ runner.os }}-clang-r547379-
            toolchains-${{ runner.os }}-dependencies

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc build-essential bison flex zip p7zip-full \
            libc6 curl libstdc++6 git wget libssl-dev zstd \
            lld python3 ccache ninja-build

      - name: Prepare for compile (${{ matrix.build-type }})
        run: |
          BRANCH="${{ matrix.build-type }}"
          git clone https://github.com/LineageOS/android_kernel_xiaomi_sm6150 \
            --depth=1 -b "$BRANCH" android_kernel_xiaomi_sm6150
          
          cp ksumakefile.patch android_kernel_xiaomi_sm6150/
          cp compile.sh android_kernel_xiaomi_sm6150/
          chmod +x ./android_kernel_xiaomi_sm6150/compile.sh

      - name: Compile the kernel
        run: |
          cd android_kernel_xiaomi_sm6150/
          
          # Set F2FS flag based on version
          if [[ "${{ matrix.build-type }}" =~ ^lineage-(22\.2|23\.0)$ ]]; then
            F2FS_FLAG="--f2fs"
          else
            F2FS_FLAG="--no-f2fs"
          fi
          
          # Set NetHunter flag (only for manual builds)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.enable-nethunter-full }}" == "true" ]]; then
            NH_FLAG="--nethunter-full"
          else
            NH_FLAG="--no-nethunter-full"
          fi
          
          # Set KProfiles flag (only for manual builds)
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.enable-kprofiles }}" == "true" ]]; then
            KP_FLAG="--kprofiles"
          else
            KP_FLAG="--no-kprofiles"
          fi
          
          echo "Starting to compile..."
          echo "F2FS: $F2FS_FLAG"
          echo "NetHunter: $NH_FLAG"
          echo "KProfiles: $KP_FLAG"
          
          ./compile.sh --ksu --ln8000 "$F2FS_FLAG" "$NH_FLAG" "$KP_FLAG"
          cd ..

      - name: Verify build artifacts
        run: |
          if [ ! -f android_kernel_xiaomi_sm6150/out/arch/arm64/boot/Image.gz ]; then
            echo "âŒ Kernel Image.gz not found!"
            exit 1
          fi
          if [ ! -f android_kernel_xiaomi_sm6150/out/arch/arm64/boot/dtb.img ]; then
            echo "âŒ DTB image not found!"
            exit 1
          fi
          if [ ! -f android_kernel_xiaomi_sm6150/out/arch/arm64/boot/dtbo.img ]; then
            echo "âŒ DTBO image not found!"
            exit 1
          fi
          echo "âœ… All build artifacts verified"

      - name: Cache AnyKernel3
        uses: actions/cache@v5.0.1
        with:
          path: AnyKernel3
          key: anykernel3-${{ hashFiles('**/anykernel.sh') }}
          restore-keys: anykernel3-

      - name: Preparing AnyKernel3
        run: |
          if [ ! -d "AnyKernel3/.git" ]; then
            rm -rf AnyKernel3
            git clone https://github.com/riarumoda/AnyKernel3 AnyKernel3 --depth=1
          fi
          
          cp android_kernel_xiaomi_sm6150/out/arch/arm64/boot/Image.gz AnyKernel3/
          cp android_kernel_xiaomi_sm6150/out/arch/arm64/boot/dtb.img AnyKernel3/
          cp android_kernel_xiaomi_sm6150/out/arch/arm64/boot/dtbo.img AnyKernel3/
          
          # Set supported Android versions based on LineageOS version
          case "${{ matrix.build-type }}" in
            lineage-20)
              sed -i 's/supported.versions=11-16/supported.versions=11-13/' AnyKernel3/anykernel.sh
              ;;
            lineage-21)
              sed -i 's/supported.versions=11-16/supported.versions=11-14/' AnyKernel3/anykernel.sh
              ;;
            lineage-22.2)
              sed -i 's/supported.versions=11-16/supported.versions=11-15/' AnyKernel3/anykernel.sh
              ;;
            lineage-23.0)
              sed -i 's/supported.versions=11-16/supported.versions=16/' AnyKernel3/anykernel.sh
              ;;
          esac

      - name: Zip kernel contents
        run: |
          fi
          
          ZIPNAME="aosp-perf-neon-${{ matrix.build-type }}${NH_SUFFIX}-${{ needs.prepare-matrix.outputs.date }}-${{ needs.prepare-matrix.outputs.timestamp }}-sweet.zip"
          cd AnyKernel3
          zip -rq9 "../$ZIPNAME" ./*
          cd ..
          
          # Generate checksums
          sha256sum "$ZIPNAME" > "${ZIPNAME}.sha256"
          md5sum "$ZIPNAME" > "${ZIPNAME}.md5"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: ${{ matrix.build-type }}-zip
          path: |
            *.zip
            *.sha256
            *.md5

  release:
    needs: [build, prepare-matrix]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List downloaded zips
        run: ls -lah artifacts

      - name: Create Release and Upload builds
        uses: softprops/action-gh-release@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: kernel-lineage-${{ needs.prepare-matrix.outputs.timestamp }}
          name: Weekly build - ${{ needs.prepare-matrix.outputs.date }}
          draft: false
          prerelease: false
          body: |
            Notes:
              > Kernel has been built with -O3 optimization flag.   
              > Kernel has been built with ln8k charger imported.   
              > F2FS Compression patch is not applied on lineage-20 and lineage-21 builds. âš ï¸ 
              > KernelSU latest manager can be found in [here](https://t.me/ksunext_ci) or in [here](https://github.com/KernelSU-Next/KernelSU-Next/actions/workflows/build-manager-ci.yml).   
          files: |
            artifacts/lineage-20-zip/*.zip
            artifacts/lineage-20-zip/*.sha256
            artifacts/lineage-20-zip/*.md5
            artifacts/lineage-21-zip/*.zip
            artifacts/lineage-21-zip/*.sha256
            artifacts/lineage-21-zip/*.md5
            artifacts/lineage-22.2-zip/*.zip
            artifacts/lineage-22.2-zip/*.sha256
            artifacts/lineage-22.2-zip/*.md5
            artifacts/lineage-23.0-zip/*.zip
            artifacts/lineage-23.0-zip/*.sha256
            artifacts/lineage-23.0-zip/*.md5
